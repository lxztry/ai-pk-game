<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç«æŠ€å¹³å° - åœ¨çº¿å¯¹æˆ˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
        }
        
        .content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .player-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .player-card.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.2);
        }
        
        .player-card h3 {
            margin-bottom: 10px;
        }
        
        .player-card .stats {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .match-controls {
            margin-top: 20px;
            text-align: center;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .rankings-table th,
        .rankings-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .rankings-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        
        .rankings-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }
        
        .rank-1 { background: #fbbf24; }
        .rank-2 { background: #94a3b8; }
        .rank-3 { background: #f97316; }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        
        .status.running {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .status.completed {
            background: rgba(34, 197, 94, 0.3);
        }
        
        .status.error {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .match-info {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŸï¸ AIç«æŠ€å¹³å° - åœ¨çº¿å¯¹æˆ˜</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('match', this)">é€‰æ‹©å¯¹æ‰‹</div>
            <div class="tab" onclick="switchTab('rankings', this)">ç§¯åˆ†æ’å</div>
            <div class="tab" onclick="switchTab('history', this)">å¯¹æˆ˜å†å²</div>
        </div>
        
        <div class="content">
            <!-- é€‰æ‹©å¯¹æ‰‹ -->
            <div id="match" class="tab-content active">
                <h2>é€‰æ‹©ä½ çš„Agentå’Œå¯¹æ‰‹</h2>
                <div id="player1-section">
                    <h3>é€‰æ‹©ä½ çš„Agent</h3>
                    <div class="player-list" id="player1-list"></div>
                </div>
                <div id="player2-section" style="margin-top: 30px; display: none;">
                    <h3>é€‰æ‹©å¯¹æ‰‹</h3>
                    <div class="player-list" id="player2-list"></div>
                </div>
                <div class="match-controls" id="match-controls" style="display: none;">
                    <div class="match-info" id="selected-players"></div>
                    <div class="match-settings" style="margin: 15px 0;">
                        <label for="max-turns-input" style="display: block; margin-bottom: 5px;">
                            æœ€å¤§å›åˆæ•°ï¼ˆé»˜è®¤500ï¼‰:
                        </label>
                        <input 
                            type="number" 
                            id="max-turns-input" 
                            value="500" 
                            min="50" 
                            max="2000" 
                            style="padding: 8px; border-radius: 5px; border: 2px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.1); color: white; width: 150px; font-size: 14px;"
                        />
                        <small style="display: block; margin-top: 5px; opacity: 0.8; font-size: 12px;">
                            èŒƒå›´ï¼š50-2000å›åˆ
                        </small>
                    </div>
                    <button onclick="startMatch()">å¼€å§‹å¯¹æˆ˜</button>
                </div>
                <div id="match-status"></div>
            </div>
            
            <!-- ç§¯åˆ†æ’å -->
            <div id="rankings" class="tab-content">
                <h2>ç§¯åˆ†æ’å</h2>
                <table class="rankings-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>ç©å®¶åç§°</th>
                            <th>ç§¯åˆ†</th>
                            <th>èƒœåœº</th>
                            <th>è´Ÿåœº</th>
                            <th>å‡»æ€</th>
                            <th>æ­»äº¡</th>
                            <th>èƒœç‡</th>
                        </tr>
                    </thead>
                    <tbody id="rankings-body"></tbody>
                </table>
            </div>
            
            <!-- å¯¹æˆ˜å†å² -->
            <div id="history" class="tab-content">
                <h2>å¯¹æˆ˜å†å²</h2>
                <div id="history-list"></div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedPlayer1 = null;
        let selectedPlayer2 = null;
        let currentMatchId = null;
        let matchCheckInterval = null;
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                document.querySelectorAll('.tab').forEach(t => {
                    if (t.textContent.includes(tabName === 'match' ? 'é€‰æ‹©å¯¹æ‰‹' : tabName === 'rankings' ? 'ç§¯åˆ†æ’å' : 'å¯¹æˆ˜å†å²')) {
                        t.classList.add('active');
                    }
                });
            }
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'rankings') {
                loadRankings();
            } else if (tabName === 'history') {
                loadHistory();
            }
        }
        
        // åŠ è½½ç©å®¶åˆ—è¡¨
        async function loadPlayers() {
            try {
                const response = await fetch('/api/players');
                const data = await response.json();
                const players = data.players;
                
                const player1List = document.getElementById('player1-list');
                const player2List = document.getElementById('player2-list');
                
                player1List.innerHTML = '';
                player2List.innerHTML = '';
                
                players.forEach(player => {
                    const card = createPlayerCard(player);
                    const card1 = card.cloneNode(true);
                    const card2 = card.cloneNode(true);
                    
                    card1.onclick = () => selectPlayer1(player);
                    card2.onclick = () => selectPlayer2(player);
                    
                    player1List.appendChild(card1);
                    player2List.appendChild(card2);
                });
            } catch (error) {
                console.error('åŠ è½½ç©å®¶å¤±è´¥:', error);
            }
        }
        
        // åˆ›å»ºç©å®¶å¡ç‰‡
        function createPlayerCard(player) {
            const card = document.createElement('div');
            card.className = 'player-card';
            card.innerHTML = `
                <h3>${player.name}</h3>
                <div class="stats">
                    <div>ç§¯åˆ†: ${player.points}</div>
                    <div>èƒœåœº: ${player.wins} | è´Ÿåœº: ${player.losses}</div>
                    <div>å‡»æ€: ${player.kills} | æ­»äº¡: ${player.deaths}</div>
                </div>
            `;
            return card;
        }
        
        // é€‰æ‹©ç©å®¶1
        function selectPlayer1(player) {
            selectedPlayer1 = player;
            document.querySelectorAll('#player1-list .player-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            document.getElementById('player2-section').style.display = 'block';
        }
        
        // é€‰æ‹©ç©å®¶2
        function selectPlayer2(player) {
            if (!selectedPlayer1) return;
            if (player.name === selectedPlayer1.name) {
                alert('ä¸èƒ½é€‰æ‹©è‡ªå·±ä½œä¸ºå¯¹æ‰‹ï¼');
                return;
            }
            selectedPlayer2 = player;
            document.querySelectorAll('#player2-list .player-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('match-controls').style.display = 'block';
            document.getElementById('selected-players').innerHTML = `
                <strong>å¯¹æˆ˜åŒæ–¹ï¼š</strong> ${selectedPlayer1.name} vs ${selectedPlayer2.name}
            `;
        }
        
        // å¼€å§‹å¯¹æˆ˜
        async function startMatch() {
            if (!selectedPlayer1 || !selectedPlayer2) {
                alert('è¯·é€‰æ‹©å¯¹æˆ˜åŒæ–¹ï¼');
                return;
            }
            
            // è·å–å›åˆæ•°é…ç½®
            const maxTurnsInput = document.getElementById('max-turns-input');
            let maxTurns = parseInt(maxTurnsInput.value, 10);
            
            // éªŒè¯å›åˆæ•°èŒƒå›´
            if (isNaN(maxTurns) || maxTurns < 50 || maxTurns > 2000) {
                alert('å›åˆæ•°å¿…é¡»åœ¨50-2000ä¹‹é—´ï¼');
                return;
            }
            
            try {
                const response = await fetch('/api/match/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        player1: selectedPlayer1.name,
                        player2: selectedPlayer2.name,
                        max_turns: maxTurns
                    })
                });
                
                const data = await response.json();
                currentMatchId = data.match_id;
                
                document.getElementById('match-status').innerHTML = `
                    <div class="status running">
                        å¯¹æˆ˜è¿›è¡Œä¸­... åŒ¹é…ID: ${currentMatchId}
                    </div>
                `;
                
                // å¼€å§‹è½®è¯¢å¯¹æˆ˜ç»“æœ
                matchCheckInterval = setInterval(checkMatchResult, 2000);
                
            } catch (error) {
                console.error('å¼€å§‹å¯¹æˆ˜å¤±è´¥:', error);
                alert('å¼€å§‹å¯¹æˆ˜å¤±è´¥: ' + error.message);
            }
        }
        
        // æ£€æŸ¥å¯¹æˆ˜ç»“æœ
        async function checkMatchResult() {
            if (!currentMatchId) return;
            
            try {
                const response = await fetch(`/api/match/${currentMatchId}`);
                const result = await response.json();
                
                if (result.status === 'completed') {
                    clearInterval(matchCheckInterval);
                    document.getElementById('match-status').innerHTML = `
                        <div class="status completed">
                            <h3>å¯¹æˆ˜å®Œæˆï¼</h3>
                            <p>è·èƒœè€…: ${result.winner || 'å¹³å±€'}</p>
                            <p>${result.player1.name}: ${result.player1.kills} å‡»æ€, ${result.player1.health} è¡€é‡</p>
                            <p>${result.player2.name}: ${result.player2.kills} å‡»æ€, ${result.player2.health} è¡€é‡</p>
                            <button onclick="window.open('/api/replay/${currentMatchId}', '_blank')">æŸ¥çœ‹å›æ”¾</button>
                            <button onclick="location.reload()">å†æ¥ä¸€å±€</button>
                        </div>
                    `;
                    loadRankings(); // åˆ·æ–°æ’å
                } else if (result.status === 'error') {
                    clearInterval(matchCheckInterval);
                    document.getElementById('match-status').innerHTML = `
                        <div class="status error">
                            å¯¹æˆ˜å¤±è´¥: ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ£€æŸ¥å¯¹æˆ˜ç»“æœå¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ’å
        async function loadRankings() {
            try {
                const response = await fetch('/api/rankings');
                const data = await response.json();
                const rankings = data.rankings;
                
                const tbody = document.getElementById('rankings-body');
                tbody.innerHTML = '';
                
                rankings.forEach((player, index) => {
                    const row = document.createElement('tr');
                    const rank = index + 1;
                    const winRate = player.total_matches > 0 
                        ? (player.wins / player.total_matches * 100).toFixed(1) + '%'
                        : '0%';
                    
                    let rankBadge = `<span class="rank-badge">${rank}</span>`;
                    if (rank <= 3) {
                        rankBadge = `<span class="rank-badge rank-${rank}">${rank}</span>`;
                    }
                    
                    row.innerHTML = `
                        <td>${rankBadge}</td>
                        <td><strong>${player.name}</strong></td>
                        <td>${player.points}</td>
                        <td>${player.wins}</td>
                        <td>${player.losses}</td>
                        <td>${player.kills}</td>
                        <td>${player.deaths}</td>
                        <td>${winRate}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('åŠ è½½æ’åå¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¯¹æˆ˜å†å²
        async function loadHistory() {
            try {
                const response = await fetch('/api/matches?limit=20');
                const data = await response.json();
                const matches = data.matches;
                
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';
                
                matches.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-info';
                    matchDiv.innerHTML = `
                        <h3>${match.player1_name} vs ${match.player2_name}</h3>
                        <p>è·èƒœè€…: ${match.winner_name || 'å¹³å±€'}</p>
                        <p>${match.player1_name}: ${match.player1_kills} å‡»æ€, ${match.player1_health} è¡€é‡</p>
                        <p>${match.player2_name}: ${match.player2_kills} å‡»æ€, ${match.player2_health} è¡€é‡</p>
                        <p><small>${new Date(match.match_date).toLocaleString('zh-CN')}</small></p>
                    `;
                    historyList.appendChild(matchDiv);
                });
            } catch (error) {
                console.error('åŠ è½½å¯¹æˆ˜å†å²å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadPlayers();
            loadRankings();
        };
    </script>
</body>
</html>

